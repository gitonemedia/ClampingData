<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Invoice #{{ clamp.id }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body{background:#fff;color:#333;font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px}
    .invoice{max-width:900px;margin:0 auto}
    .header{text-align:center;margin-bottom:20px}
    .invoice-table{width:100%;border-collapse:collapse}
    .invoice-table td{padding:10px;border-bottom:1px solid #eee}
    .big{font-size:1.1rem}
  </style>
</head>
<body>
  <div class="invoice">
    <div class="header">
      <h1>PAID INVOICE</h1>
      <p>Invoice #{{ clamp.id }} â€” Generated: {{ now.strftime('%Y-%m-%d %H:%M') }}</p>
    </div>
    <table class="invoice-table">
      <tr><td><strong>Location</strong></td><td class="big">{{ clamp.location }}</td></tr>
      <tr><td><strong>Registration</strong></td><td class="big">{{ clamp.registration or 'N/A' }}</td></tr>
      <tr><td><strong>Date</strong></td><td>{{ clamp.clamp_date.strftime('%Y-%m-%d') }}</td></tr>
      <tr><td><strong>Time In</strong></td><td>{{ clamp.time_in.strftime('%H:%M') }}</td></tr>
      <tr><td><strong>Time Released</strong></td><td>{{ clamp.time_released.strftime('%H:%M') if clamp.time_released else 'N/A' }}</td></tr>
      <tr><td><strong>Offense</strong></td><td>{{ clamp.offense }}</td></tr>
      <tr><td><strong>Status</strong></td><td>{{ clamp.payment_status }}</td></tr>
      <tr>
        <td><strong>Amount (USD)</strong></td>
        <td>
          <input id="amount-input" type="number" step="0.01" min="0" value="{{ '%.2f'|format(clamp.amount_paid or 0) }}" style="font-size:1.1rem;padding:6px;width:150px">
        </td>
      </tr>
    </table>
    <div style="margin-top:30px;text-align:center;color:#666;font-size:0.9rem">Present display mode</div>
  </div>
  <script>
    (function(){
      var inp = document.getElementById('amount-input');
      var statusCell = document.querySelector('.invoice-table td:contains("{{ clamp.payment_status }}")');
      // Fallback: also add/update status using a small id if available
      function toFloat(v){var n=parseFloat(v);return isNaN(n)?0:n;}

      function updateStatusText(text){
        // Try to find the Status cell by searching rows
        var rows = document.querySelectorAll('.invoice-table tr');
        rows.forEach(function(r){
          var th = r.querySelector('td:first-child');
          if(th && th.textContent.trim() === 'Status'){
            var td = r.querySelector('td:nth-child(2)');
            if(td) td.textContent = text;
          }
        });
      }

      if(!inp) return;

      function saveAmount(){
        var val = toFloat(inp.value);
        inp.disabled = true;
        fetch('/api/clamp/' + {{ clamp.id }} + '/amount', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({amount_paid: val})
        }).then(function(resp){
          if(!resp.ok) throw new Error('Server error');
          return resp.json();
        }).then(function(json){
          inp.value = (json.amount_paid||0).toFixed(2);
          updateStatusText((json.amount_paid && json.amount_paid>0)?'Paid':'Not Paid');
        }).catch(function(err){
          alert('Failed to save amount: ' + err.message);
        }).finally(function(){
          inp.disabled = false;
        });
      }

      inp.addEventListener('change', saveAmount);
      inp.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); inp.blur(); } });
    })();
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Invoice #{{ clamp.id }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body{background:#fff;color:#333;font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px}
    .invoice{max-width:900px;margin:0 auto}
    .header{text-align:center;margin-bottom:20px}
    .invoice-table{width:100%;border-collapse:collapse}
    .invoice-table td{padding:10px;border-bottom:1px solid #eee}
    .big{font-size:1.1rem}
  </style>
</head>
<body>
  <div class="invoice">
    <div class="header">
      <h1>PAID INVOICE</h1>
      <p>Invoice #{{ clamp.id }} — Generated: {{ now.strftime('%Y-%m-%d %H:%M') }}</p>
    </div>
    <table class="invoice-table">
      <tr><td><strong>Location</strong></td><td class="big">{{ clamp.location }}</td></tr>
      <tr><td><strong>Registration</strong></td><td class="big">{{ clamp.registration or 'N/A' }}</td></tr>
      <tr><td><strong>Date</strong></td><td>{{ clamp.clamp_date.strftime('%Y-%m-%d') }}</td></tr>
      <tr><td><strong>Time In</strong></td><td>{{ clamp.time_in.strftime('%H:%M') }}</td></tr>
      <tr><td><strong>Time Released</strong></td><td>{{ clamp.time_released.strftime('%H:%M') if clamp.time_released else 'N/A' }}</td></tr>
      <tr><td><strong>Offense</strong></td><td>{{ clamp.offense }}</td></tr>
      <tr><td><strong>Status</strong></td><td>{{ clamp.payment_status }}</td></tr>
      <tr>
        <td><strong>Amount (USD)</strong></td>
        <td>
          <input id="amount-input" type="number" step="0.01" min="0" value="{{ '%.2f'|format(clamp.amount_paid or 0) }}" style="font-size:1.1rem;padding:6px;width:150px">
          <span id="spinner" style="display:none;margin-left:8px">⏳</span>
        </td>
      </tr>
    </table>
    <div style="margin-top:30px;text-align:center;color:#666;font-size:0.9rem">Present display mode</div>
  </div>
  <style>
    #toast-p { position: fixed; right: 20px; bottom: 20px; min-width:200px; padding:10px 14px; border-radius:6px; color:#fff; display:none }
    #toast-p.success{ background: #28a745 }
    #toast-p.error{ background: #dc3545 }
  </style>
  <div id="toast-p"></div>
  <script>
    (function(){
      var inp = document.getElementById('amount-input');
      var spinner = document.getElementById('spinner');

      function toFloat(v){var n=parseFloat(v);return isNaN(n)?0:n;}

      function showToast(msg, ok){
        var t = document.getElementById('toast-p');
        t.textContent = msg; t.className = ok ? 'success' : 'error'; t.style.display = 'block';
        clearTimeout(t._hide);
        t._hide = setTimeout(function(){ t.style.display = 'none'; }, 3000);
      }

      function updateStatusText(text){
        var rows = document.querySelectorAll('.invoice-table tr');
        rows.forEach(function(r){
          var th = r.querySelector('td:first-child');
          if(th && th.textContent.trim() === 'Status'){
            var td = r.querySelector('td:nth-child(2)');
            if(td) td.textContent = text;
          }
        });
      }

      if(!inp) return;

      function saveAmount(){
        var val = toFloat(inp.value);
        inp.disabled = true; if(spinner) spinner.style.display = '';
        fetch('/api/clamp/' + {{ clamp.id }} + '/amount', {
          method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({amount_paid: val})
        }).then(function(resp){
          if(!resp.ok) throw new Error('Server error'); return resp.json();
        }).then(function(json){
          inp.value = (json.amount_paid||0).toFixed(2);
          updateStatusText((json.amount_paid && json.amount_paid>0)?'Paid':'Not Paid');
          showToast('Saved', true);
        }).catch(function(err){
          showToast('Save failed', false);
        }).finally(function(){ inp.disabled = false; if(spinner) spinner.style.display = 'none'; });
      }

      inp.addEventListener('blur', saveAmount);
      inp.addEventListener('keydown', function(e){ if(e.key === 'Enter'){ e.preventDefault(); inp.blur(); } });
    })();
  </script>
</body>
</html>
